---
title: "openarchaeoCollaboration"
author:
  - name: Zack Batist
    url: https://zackbatist.github.io
    affiliation: University of Toronto
  - name: Joe Roe
    url: https://joeroe.io
    affiliation: University of Copenhagen
date: "`r Sys.Date()`"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	layout = "l-body-outset"
)
```

```{r dependencies, include=FALSE}
library("tidyverse")
library("lubridate")
library("openarchaeoCollaboration")
library("khroma")
```

## Materials and methods

We used *open-archaeo* <https://open-archaeo.info/>, a list of open source archaeological software and other digital resources.
The criteria for inclusion in open-archaeo are [...].
The search strategy for compiling it was [...].

```{r data-oarch}
read_csv("https://raw.githubusercontent.com/zackbatist/open-archaeo/master/open-archaeo.csv") %>%
  mutate(category = na_if(category, "?")) %>%
  mutate(gh_repo = str_remove(github, "https://github.com/")) ->
  oarch

oarch <- mutate(oarch, rough_category = recode(category,
                                 "R" = "Packages (R, Python, etc.)",
                                 "Web apps" = "Standalone apps",
                                 "Datasets" = "Analyses & datasets",
                                 "Tutorials" = "Lists & tutorials",
                                 "Python" = "Packages (R, Python, etc.)",
                                 "Desktop apps" = "Standalone apps",
                                 "QGIS" = "Plugins",
                                 "Lists" = "Lists & tutorials",
                                 "Mobile apps" = "Standalone apps",
                                 "Analyses" = "Analyses & datasets",
                                 "Spreadsheets" = "Forms & spreadsheets",
                                 "Command line tools" = "Standalone apps",
                                 "Plugins" = "Plugins",
                                 "ArcGis" = "Plugins",
                                 "Filemaker" = "Plugins",
                                 "ODK" = "Forms & spreadsheets",
                                 "Lisp" = "Packages (R, Python, etc.)",
                                 .default = "Other",
                                 .missing = "Other"
                                 ))
```

We augmented this with data from the GitHub API for records with an associated GitHub repository.

```{r data-github}
# Warning: slow
oarch <- mutate(oarch,
                gh_langs = map(oarch$gh_repo, gh_lang),
                gh_contribs = map(oarch$gh_repo, gh_contrib),
                gh_issues = map(oarch$gh_repo, gh_issue),
                gh_comments = map(oarch$gh_repo, gh_comment),
                gh_commits = map(oarch$gh_repo, gh_commit)
)
```

## Results

### Tags and categories

```{r plot-categories}
oarch %>%
  group_by(category) %>%
  drop_na(category) %>%
  summarise(n = n()) %>%
  ggplot(aes(fct_reorder(category, n), n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Open archaeology categories",
    caption = "Data: <https://open-archaeo.info>",
    x = NULL, y = "Number of projects"
  )
```

```{r plot-tags}
oarch %>%
  pivot_longer(c(tag1, tag2, tag3, tag4, tag5), values_to = "tag",
               values_drop_na = TRUE) %>%
  group_by(tag) %>%
  drop_na(tag) %>%
  summarise(n = n()) %>%
  ggplot(aes(fct_reorder(tag, n), n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Open archaeology tags",
    caption = "Data: <https://open-archaeo.info>",
    x = NULL, y = "Number of projects"
  )
```

### Use of GitHub

```{r plot-gh_commits-cum}
oarch %>%
  unnest(gh_commits) %>%
  drop_na(sha) %>%
  mutate(date = floor_date(datetime, "week")) %>%
  mutate(rough_category = recode(
    rough_category,
    "Standalone apps" = "Standalone apps",
    "Packages (R, Python, etc.)" = "Packages (R, Python, etc.)",
    .default = "Other")) %>%
  group_by(rough_category, date) %>%
  summarise(n_commits = n(), .groups = "drop_last") %>%
  mutate(cat_total = sum(n_commits)) %>%
  mutate(cum_commits = cumsum(n_commits)) %>%
  ggplot(aes(date, cum_commits,
             fill = fct_reorder(rough_category, cat_total),
             colour = fct_reorder(rough_category, cat_total))) +
  geom_area() +
  scale_x_datetime(limits = c(ymd("2008-01-01", tz = "UTC"), NA),
                   date_breaks = "1 years",
                   date_labels = "%Y") +
  scale_colour_contrast(guide = NULL) +
  scale_fill_contrast(guide = guide_legend(reverse = TRUE)) +
  labs(
    title = "Open Archaeology",
    subtitle = "Cumulative commits in GitHub repositories",
    caption = "Data: <https://open-archaeo.info> and the GitHub API",
    x = NULL, y = NULL, fill = NULL
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "IBM Plex Sans"),
    legend.position = "bottom", 
    legend.justification = "right",
    legend.margin = margin(),
    legend.box.margin = margin()
  )
```

```{r plot-gh_langs, fig.show="hold", out.width="50%"}
oarch %>%
  unnest(gh_langs) %>%
  drop_na(lang, bytes) %>%
  group_by(lang) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(-n) %>%
  slice(1:10) %>%
  ggplot(aes(fct_reorder(lang, n, .desc = TRUE), n)) +
  geom_col() +
  labs(title = "Languages used in GitHub repositories",
       subtitle = "Number of repositories using top 10 languages",
       caption = "Data: <https://open-archaeo.info> and the GitHub API",
       x = NULL, y = "Number of repositories")

oarch %>%
  unnest(gh_langs) %>%
  drop_na(lang, bytes) %>%
  group_by(lang) %>%
  summarise(bytes = sum(bytes), .groups = "drop") %>%
  arrange(-bytes) %>%
  slice(1:10) %>%
  ggplot(aes(fct_reorder(lang, bytes, .desc = TRUE), bytes)) +
  geom_col() +
  labs(title = "Languages used in GitHub repositories",
       subtitle = "Total bytes of code in top 10 languages",
       caption = "Data: <https://open-archaeo.info> and the GitHub API",
       x = NULL, y = "Bytes")
```

### Repository contributors

```{r plot-gh_contributors-histogram}
oarch %>%
  drop_na(gh_repo) %>%
  unnest(gh_contribs) %>%
  group_by(gh_repo) %>%
  summarise(n = n(), .groups = "drop") %>%
  ggplot(aes(x = n)) +
  geom_histogram(binwidth = 1) +
  labs(
    title = "Repository contributors",
    caption = "Data: <https://open-archaeo.info> and the GitHub API",
    x = "Number of contributors", y = "Number of repositories"
  )
```
