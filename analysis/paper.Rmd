---
title: "openarchaeoCollaboration"
author:
  - name: Zack Batist
    url: https://zackbatist.github.io
    affiliation: University of Toronto
  - name: Joe Roe
    url: https://joeroe.io
    affiliation: University of Copenhagen
date: "`r Sys.Date()`"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	layout = "l-body-outset"
)
```

```{r dependencies, include=FALSE}
library("tidyverse")
library("lubridate")
library("openarchaeoCollaboration")
library("khroma")
```

## Introduction

Research objectives and questions:

* What types of open source projects are being developed by archaeologists?
  * How many projects are there?
  * What do they do?
  * What languages are they written in and/or what platform do they use?
  * How has this changed over time?
* To what extent to these projects leverage tools for collaborative software engineering?
  * How many entries use version control?
  * How many entries have an explicit license?
  * What are the most popular licenses?
  * What are the most popular repository hosts?
  * How active is the average repository?
  * How fast have repositories been growing?
  * How many people contribute to individual repositories?
  * What roles do contributors to repositories have?
  * Are networks of collaboration emerging?
  * Contributions over time: is open source software in archaeology growing?
  * How frequently used are forks, pull requests, issues, and comments used?
  * How frequently used are 'engagement' features like stars, follows, and releases?
  * Collaboration over time: is the use of these features becoming more common?
* Does collaboration in software development mirror, or differ from, collaborative practices in archaeological research more broadly?

## Background

- Lots of reviews out there on sets of tools geared towards specific kinds of applications
  - i.e. for aerial photo recognition, for photogrammetry, for tablet data collection, etc

- A few papers encouraging use of open source tools and platforms
  - @schmidt2020, @ducke2012, @orengo2015, @ducke2015, @ross2015, @wells2015

- @jeffrey2012, @beck2012, @bevan2012 on the new kinds of engagements and commitments that openness entails
  - @hansen2019 on the structural/systemtic challenges involved in maintaining a proper archaeological database
  - @parsons2013, @kansa2014a on carrying over existing ideas and modes of production

- On community-building
  - @carman2017 on the community-building and @carman2006 on the social practice of digging; we might extend this to discuss extended network of archaeological practices, which now includes software development
  - @morgan2012, @richardson2017b, @huggett2004 on encouraging wider participation within open collaboration networks
  - @morgan2015 and @caraher2019 on anarchic ethos in archaeology, see also responses by @richardson2017; we might draw parallels with similar worldviews in open source software development (i.e. hacker and DIY culture)
  - @sholler2019 wrote a general guide for encouraging participation within open source research projects (but not as an archaeologist)

- @daems2020 on educating students to use digital tools, and @morgan2018a on problems with making tools easy to use (relates to @caraher2015's value of friction)
  - Might also draw from @graham2019 and @graham2020 on pedagogical and exploratory aspects of hacking away


## Materials and methods

We used *open-archaeo* <https://open-archaeo.info/>, a list of open source archaeological software and other digital resources.
The criteria for inclusion in open-archaeo are [...].
The search strategy for compiling it was [...].

```{r data-oarch}
read_csv("https://raw.githubusercontent.com/zackbatist/open-archaeo/master/open-archaeo.csv") %>%
  mutate(category = na_if(category, "?")) ->
  oarch

# Extract clean repos from GitHub URLs
oarch %>% 
  mutate(
    gh_repo = str_match(oarch$github, "^https://github.com/([\\w-\\.]+/[\\w-\\.]+)/?.*?$")[,2]
  ) ->
  oarch

# Amalgamate categories into fewer rough categories
# TODO: redo
oarch <- mutate(oarch, rough_category = recode(category,
                                 "R" = "Packages (R, Python, etc.)",
                                 "Web apps" = "Standalone apps",
                                 "Datasets" = "Analyses & datasets",
                                 "Tutorials" = "Lists & tutorials",
                                 "Python" = "Packages (R, Python, etc.)",
                                 "Desktop apps" = "Standalone apps",
                                 "QGIS" = "Plugins",
                                 "Lists" = "Lists & tutorials",
                                 "Mobile apps" = "Standalone apps",
                                 "Analyses" = "Analyses & datasets",
                                 "Spreadsheets" = "Forms & spreadsheets",
                                 "Command line tools" = "Standalone apps",
                                 "Plugins" = "Plugins",
                                 "ArcGis" = "Plugins",
                                 "Filemaker" = "Plugins",
                                 "ODK" = "Forms & spreadsheets",
                                 "Lisp" = "Packages (R, Python, etc.)",
                                 .default = "Other",
                                 .missing = "Other"
                                 ))
```

We augmented this with data from the GitHub API for records with an associated GitHub repository.

```{r data-github}
# Warning: slow
oarch <- mutate(oarch,
                gh_langs = map(oarch$gh_repo, gh_lang),
                gh_contribs = map(oarch$gh_repo, gh_contrib),
                gh_issues = map(oarch$gh_repo, gh_issue),
                gh_comments = map(oarch$gh_repo, gh_comment),
                gh_commits = map(oarch$gh_repo, gh_commit)
)
```

## Results

### Open archaeology

TODO [ZB]: Can you explain the logic behind the taxonomies, either here or in materials?

#### Categories and tags

```{r plot-categories}
oarch %>%
  group_by(category) %>%
  drop_na(category) %>%
  summarise(n = n()) %>%
  ggplot(aes(fct_reorder(category, n), n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Categories",
    caption = "Data: open-archaeo.info",
    x = NULL, y = "Number of projects"
  )
```

```{r plot-tags, fig.asp=2}
oarch %>%
  pivot_longer(c(tag1, tag2, tag3, tag4, tag5), values_to = "tag",
               values_drop_na = TRUE) %>%
  group_by(tag) %>%
  drop_na(tag) %>%
  summarise(n = n()) %>%
  ggplot(aes(fct_reorder(tag, n), n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Tags",
    caption = "Data: open-archaeo.info",
    x = NULL, y = "Number of projects"
  )
```

#### Languages and platforms

The GitHub API provides data on the languages used in a repository based on an automated machine learning algorithm.
Since most repositories use more than one language—if only one for the actual software, and another (e.g. HTML) for documentation—this data is presented as a table of languages and the number of bytes of code in that language detected in the repository.
We can therefore measure the popularity of languages across repositories in a couple of ways: based on how many repositories use a language at all; or based on how many bytes of that language are present.

```{r plot-gh_langs, fig.show="hold", out.width="50%"}
oarch %>%
  unnest(gh_langs) %>%
  drop_na(lang, bytes) %>%
  group_by(lang) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(-n) %>%
  slice(1:10) %>%
  ggplot(aes(fct_reorder(lang, n, .desc = TRUE), n)) +
  geom_col() +
  labs(title = "Repository languages",
       subtitle = "Number of repositories using top 10 languages",
       caption = "Data: open-archaeo.info and GitHub API",
       x = NULL, y = "Number of repositories")

oarch %>%
  unnest(gh_langs) %>%
  drop_na(lang, bytes) %>%
  group_by(lang) %>%
  summarise(bytes = sum(bytes), .groups = "drop") %>%
  arrange(-bytes) %>%
  slice(1:10) %>%
  ggplot(aes(fct_reorder(lang, bytes, .desc = TRUE), bytes)) +
  geom_col() +
  labs(title = "Repository languages",
       subtitle = "Total bytes of code in top 10 languages",
       caption = "Data: open-archaeo.info and GitHub API",
       x = NULL, y = "Bytes")
```

Looking at number of bytes puts C++ and the web languages (HTML, PHP, and Javascript) on top, but this is probably affected by the relative verboseness of these languages and the popularity of web-based documentation across implementation languages. The number of repositories is probably more reliable and shows the popularity of scientific programming languages—R and Python—followed by web languages and then compiled C and C++.

We also have a 'platform' taxonomy, which is a manually-classified description of the broad framework that the individual projects rely on.

```{r plot-platforms}
oarch %>%
  group_by(platform) %>%
  drop_na(platform) %>%
  summarise(n = n()) %>%
  ggplot(aes(fct_reorder(platform, n), n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Repository platforms",
    caption = "Data: open-archaeo.info",
    x = NULL, y = "Number of projects"
  )
```

Here again we see R is overwhelmingly dominant; closely followed by Python.
Plugins for QGIS and mobile apps are also relatively popular.
The remainder show a rather fragmented landscape of plugins for other desktop software (e.g. AutoCAD, ArcGIS); lesser used programming languages; and custom form and spreadsheet templates.

### Open source

#### Code availability and license

All entries on open-archaeo include source code in some form, but how many have a version-controlled repository? What repository hosts are the most popular?

```{r plot-repo-hosts}
# TODO: add "none"
oarch %>% 
  pivot_longer(c(github, gitlab, bitbucket, launchpad, codeberg),
               names_to = "repo_host", values_to = "repo_url") %>% 
  drop_na(repo_url) %>% 
  count(repo_host) %>% 
  arrange(-n) %>%
  ggplot(aes(fct_reorder(repo_host, n, .desc = TRUE), n)) +
  geom_col() +
  labs(title = "Repository hosts",
       caption = "Data: open-archaeo.info",
       x = NULL, y = "Number of projects")
```

How many are explicitly licensed? What are the most popular licenses?

#### Repository activity

(On GitHub:)

  * How active is the average repository?
  * How fast have repositories been growing?

```{r plot-gh_commits-cum}
oarch %>%
  unnest(gh_commits) %>%
  drop_na(sha) %>%
  mutate(date = floor_date(datetime, "week")) %>%
  mutate(rough_category = recode(
    rough_category,
    "Standalone apps" = "Standalone apps",
    "Packages (R, Python, etc.)" = "Packages (R, Python, etc.)",
    .default = "Other")) %>%
  group_by(rough_category, date) %>%
  summarise(n_commits = n(), .groups = "drop_last") %>%
  mutate(cat_total = sum(n_commits)) %>%
  mutate(cum_commits = cumsum(n_commits)) %>%
  ggplot(aes(date, cum_commits,
             fill = fct_reorder(rough_category, cat_total),
             colour = fct_reorder(rough_category, cat_total))) +
  geom_area() +
  scale_x_datetime(limits = c(ymd("2008-01-01", tz = "UTC"), NA),
                   date_breaks = "1 years",
                   date_labels = "%Y") +
  scale_colour_contrast(guide = NULL) +
  scale_fill_contrast(guide = guide_legend(reverse = TRUE)) +
  labs(
    title = "Open Archaeology",
    subtitle = "Cumulative commits in GitHub repositories",
    caption = "Data: <https://open-archaeo.info> and the GitHub API",
    x = NULL, y = NULL, fill = NULL
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "IBM Plex Sans"),
    legend.position = "bottom",
    legend.justification = "right",
    legend.margin = margin(),
    legend.box.margin = margin()
  )
```

#### Growth

### Collaboration

#### Number of collaborators and roles

```{r plot-gh_contributors-histogram}
oarch %>%
  drop_na(gh_repo) %>%
  unnest(gh_contribs) %>%
  group_by(gh_repo) %>%
  summarise(n = n(), .groups = "drop") %>%
  ggplot(aes(x = n)) +
  geom_histogram(binwidth = 1) +
  labs(
    title = "Repository contributors",
    caption = "Data: <https://open-archaeo.info> and the GitHub API",
    x = "Number of contributors", y = "Number of repositories"
  )
```

#### Forks and pull requests

#### Issues and comments

```{r plot-gh_issues-histogram}
oarch %>%
  unnest(gh_issues) %>%
  drop_na(title) %>%
  group_by(repo) %>%
  summarise(n = n(), .groups = "drop") %>%
  ggplot(aes(x = n)) +
  geom_histogram(binwidth = 1) +
  labs(
    title = "Repository issues",
    caption = "Data: <https://open-archaeo.info> and the GitHub API",
    x = "Number of issues", y = "Number of repositories"
  )
```


#### Collaborative networks

If we construct a network linking repositories by their common contributors, can we identify emerging networks of collaboration, or are individual projects still largely isolated? If there are networks, what characterises their links?
