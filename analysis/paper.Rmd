---
title: "openarchaeoCollaboration"
author:
  - name: Zack Batist
    url: https://zackbatist.github.io
    affiliation: University of Toronto
  - name: Joe Roe
    url: https://joeroe.io
    affiliation: University of Copenhagen
date: "`r Sys.Date()`"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	layout = "l-body-outset"
)
```

```{r dependencies, include=FALSE}
library("tidyverse")
library("lubridate")
library("openarchaeoCollaboration")
library("khroma")
```

## Introduction

Research objectives and questions:

* What types of open source projects are being developed by archaeologists?
  * How many projects are there?
  * What do they do?
  * What languages are they written in and/or what platform do they use?
  * How has this changed over time?
* To what extent to these projects leverage tools for collaborative software engineering?
  * How many entries use version control?
  * How many entries have an explicit license?
  * What are the most popular licenses?
  * What are the most popular repository hosts?
  * How active is the average repository?
  * How fast have repositories been growing?
  * How many people contribute to individual repositories?
  * What roles do contributors to repositories have?
  * Are networks of collaboration emerging?
  * Contributions over time: is open source software in archaeology growing?
  * How frequently used are forks, pull requests, issues, and comments used?
  * How frequently used are 'engagement' features like stars, follows, and releases?
  * Collaboration over time: is the use of these features becoming more common?
* Does collaboration in software development mirror, or differ from, collaborative practices in archaeological research more broadly?

ZB note: The following relates to what we were discussing last week, and hopefully is a start at making our research questions more relevant to general discourse. We can heavily modify this if we do not want to get too far into the general discourse.

This survey will help identify factors that contribute the simultaneous growth and stagnation of archaeological software development. The extreme optimism expressed during the early 2010s regarding the potential value that open source development models would bring (particularly in the 2012 special issue of World Archaeology) has been both realized and slow to take off. Open source is either a perpetual novelty or a normalized attitude in different circles. In this sense, our study is primarily about the development of norms and practices, and the delegation or distribution of various kinds of activities, throughout the archaeological community.

We do this is by leveraging metrics of contributions made by involved participants. These metrics reflect how work is _actually_ delegated or distributed, which tempers and perhaps even contradicts common conceptions about how collaborative software development operates.

We emphasize how on highlighting the unique flavour of open source software development that pertains to archaeology specifically. It's ok if we are not purists, or if we do not operate in the same ways as other scientific disciplines or Silicon Valley startups. We have our own constraints to deal with, and our own distinct goals, mindsets and modes of organizing ourselves that differ from those communities. Our goal in this paper is to identify what's going on, to highlight our unique archaeological open source culture, and how that culture has emerged and continues to develop.

## Background

- Lots of reviews out there on sets of tools geared towards specific kinds of applications
  - i.e. for aerial photo recognition, for photogrammetry, for tablet data collection, etc

- A few papers encouraging use of open source tools and platforms
  - @schmidt2020, @ducke2012, @orengo2015, @ducke2015, @ross2015, @wells2015

- @jeffrey2012, @beck2012, @bevan2012 on the new kinds of engagements and commitments that openness entails
  - @hansen2019 on the structural/systemtic challenges involved in maintaining a proper archaeological database
  - @parsons2013, @kansa2014a on carrying over existing ideas and modes of production

- On community-building
  - @carman2017 on the community-building and @carman2006 on the social practice of digging; we might extend this to discuss extended network of archaeological practices, which now includes software development
  - @morgan2012, @richardson2017b, @huggett2004 on encouraging wider participation within open collaboration networks
  - @morgan2015 and @caraher2019 on anarchic ethos in archaeology, see also responses by @richardson2017; we might draw parallels with similar worldviews in open source software development (i.e. hacker and DIY culture)
  - @sholler2019 wrote a general guide for encouraging participation within open source research projects (but not as an archaeologist)

- @daems2020 on educating students to use digital tools, and @morgan2018a on problems with making tools easy to use (relates to @caraher2015's value of friction)
  - Might also draw from @graham2019 and @graham2020 on pedagogical and exploratory aspects of hacking away

## Materials and methods

We used *open-archaeo* <https://open-archaeo.info/>, a list of open source archaeological software and other digital resources. As of June 8, 2021, 401 items are listed. Items are included in open-archaeo if a project is identified by its maintainers as relating to archaeological work.

The dataset was compiled by browsing collaborative software development platforms, essentially manually crawling through the profiles of users who identify as archaeologists or who have contributed to tools that pertain to archaeological work. This quasi-systematic collection strategy was also supplemented by contributions made by interested individuals who identified relevant work that was initially overlooked.

Open-archaeo is a relatively comprehensive list, however it generally lacks code written before the growth and general use of collaborative software development platforms among archaeologists (which seems to have began during the early-2010s) and code that is not available on the web. Additionally, items pertaining to various specialist domains may be spotty, owing to the limited experiences of the list's primary maintainers. To help resolve this issue, open-archaeo has put out a call specialists to perform 'deep dives' into the software ecosystems pertaining to their methodological or subject domains. Thus far, one 'deep dive' into tools used in archaeogenetics has been initiated.

```{r data-oarch}
read_csv("https://raw.githubusercontent.com/zackbatist/open-archaeo/master/open-archaeo.csv") %>%
  mutate(category = na_if(category, "?")) ->
  oarch

# Extract clean repos from GitHub URLs
oarch %>% 
  mutate(
    gh_repo = str_match(oarch$github, "^https://github.com/([\\w-\\.]+/[\\w-\\.]+)/?.*?$")[,2]
  ) ->
  oarch

# Amalgamate categories into fewer rough categories
# TODO: redo
oarch <- mutate(oarch, rough_category = recode(category,
                                 "R" = "Packages (R, Python, etc.)",
                                 "Web apps" = "Standalone apps",
                                 "Datasets" = "Analyses & datasets",
                                 "Tutorials" = "Lists & tutorials",
                                 "Python" = "Packages (R, Python, etc.)",
                                 "Desktop apps" = "Standalone apps",
                                 "QGIS" = "Plugins",
                                 "Lists" = "Lists & tutorials",
                                 "Mobile apps" = "Standalone apps",
                                 "Analyses" = "Analyses & datasets",
                                 "Spreadsheets" = "Forms & spreadsheets",
                                 "Command line tools" = "Standalone apps",
                                 "Plugins" = "Plugins",
                                 "ArcGis" = "Plugins",
                                 "Filemaker" = "Plugins",
                                 "ODK" = "Forms & spreadsheets",
                                 "Lisp" = "Packages (R, Python, etc.)",
                                 .default = "Other",
                                 .missing = "Other"
                                 ))
```

We augmented this with data from the GitHub API for records with an associated GitHub repository.

```{r data-github}
# Warning: slow
oarch <- mutate(oarch,
                gh_langs = map(oarch$gh_repo, gh_lang),
                gh_contribs = map(oarch$gh_repo, gh_contrib),
                gh_issues = map(oarch$gh_repo, gh_issue),
                gh_comments = map(oarch$gh_repo, gh_comment),
                gh_commits = map(oarch$gh_repo, gh_commit)
)
```

Each record is also annotated with tags that describe the aspects of archaeological work that each tool contributes to. Items are tagged based on how they have been identified or presented by their maintainers. The list of tags and their associated definitions is subject to grow or change as archaeologists continue to develop software for additional use cases.

Records are also categorized based on how each tool or resource is accessed or used. This gives us a sense of the pervasiveness of various development models, and the requirements or dependent knowledge that devs impose on their users.

Two kinds of categories have been defined: software and documents. Software comprise collections of instructions that dictate how a computer should operate. Documents are bounded sets of recorded information. Three categories of software and four categories of documents are defined below.

|Category|Kind|Scope|
|:-------|:---|:----|
|Packages and libraries|Software|Sets of functions assembled with clear purpose, and made accessible using standards established by an underlying platform.|
|Standalone software|Software|Software that may be operated without needing to first access an underlying platform.|
|Scripts|Software|Sets of pragmatically assembled mutable functions, often lacking complete documentation or adherence to protocols that would otherwise facilitate secondary use outside their original contexts of creation.|
|Specifications, protocols and schemas|Documents|A formal data structure or framework intended to be used as a model.|
|Products|Documents|Stable outcomes of creative work.|
|Guides|Documents|An educational resource or documented protocol meant to instruct readers how to apply relevant tools or techniques.|
|Lists and datasets|Documents|A series of consistently organized observations assembled with purpose.|

## Results

### Open archaeology

TODO [ZB]: Can you explain the logic behind the taxonomies, either here or in materials?

#### Categories and tags

```{r plot-categories}
oarch %>%
  group_by(category) %>%
  drop_na(category) %>%
  summarise(n = n()) %>%
  ggplot(aes(fct_reorder(category, n), n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Categories",
    caption = "Data: open-archaeo.info",
    x = NULL, y = "Number of projects"
  )
```

```{r plot-tags, fig.asp=2}
# TODO: some merging of tags
oarch %>%
  pivot_longer(c(tag1, tag2, tag3, tag4, tag5), values_to = "tag",
               values_drop_na = TRUE) %>%
  group_by(tag) %>%
  drop_na(tag) %>%
  summarise(n = n()) %>%
  ggplot(aes(fct_reorder(tag, n), n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Tags",
    caption = "Data: open-archaeo.info",
    x = NULL, y = "Number of projects"
  )
```

Which tags co-occur more often?

```{r plot-tags-combo}
# NB. Plot in a big window if you want to actually read this!
oarch %>%
  pivot_longer(c(tag1, tag2, tag3, tag4, tag5), values_to = "tag",
               values_drop_na = TRUE) %>%
  select(item_name, tag) %>% 
  left_join(., ., by = "item_name") %>% # Join to self
  group_by(tag.x, tag.y) %>% 
  count() %>% 
  filter(tag.x != tag.y) %>% 
  ggplot(aes(tag.x, tag.y, label = n)) +
  geom_tile(fill = "black") +
  geom_text(colour = "white") +
  scale_fill_davos(guide = guide_none()) +
  coord_fixed() +
  labs(title = "Co-occurrence of tags",
       caption = "Data: open-archaeo.info",
       x = NULL, y = NULL) +
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1)
  )
```

#### Languages and platforms

TODO: colour by platform

The GitHub API provides data on the languages used in a repository based on an automated machine learning algorithm.
Since most repositories use more than one language—if only one for the actual software, and another (e.g. HTML) for documentation—this data is presented as a table of languages and the number of bytes of code in that language detected in the repository.
We can therefore measure the popularity of languages across repositories in a couple of ways: based on how many repositories use a language at all; or based on how many bytes of that language are present.

```{r plot-gh_langs, fig.show="hold", out.width="50%"}
oarch %>%
  unnest(gh_langs) %>%
  drop_na(lang, bytes) %>%
  group_by(lang) %>%
  summarise(n = n(), .groups = "drop") %>%
  arrange(-n) %>%
  slice(1:10) %>%
  ggplot(aes(fct_reorder(lang, n, .desc = TRUE), n)) +
  geom_col() +
  labs(title = "Repository languages",
       subtitle = "Number of repositories using top 10 languages",
       caption = "Data: open-archaeo.info and GitHub API",
       x = NULL, y = "Number of repositories")

oarch %>%
  unnest(gh_langs) %>%
  drop_na(lang, bytes) %>%
  group_by(lang) %>%
  summarise(bytes = sum(bytes), .groups = "drop") %>%
  arrange(-bytes) %>%
  slice(1:10) %>%
  ggplot(aes(fct_reorder(lang, bytes, .desc = TRUE), bytes)) +
  geom_col() +
  labs(title = "Repository languages",
       subtitle = "Total bytes of code in top 10 languages",
       caption = "Data: open-archaeo.info and GitHub API",
       x = NULL, y = "Bytes")
```

Looking at number of bytes puts C++ and the web languages (HTML, PHP, and Javascript) on top, but this is probably affected by the relative verboseness of these languages and the popularity of web-based documentation across implementation languages. The number of repositories is probably more reliable and shows the popularity of scientific programming languages—R and Python—followed by web languages and then compiled C and C++.

We also have a 'platform' taxonomy, which is a manually-classified description of the broad framework that the individual projects rely on.

```{r plot-platforms}
oarch %>%
  group_by(platform) %>%
  drop_na(platform) %>%
  summarise(n = n()) %>%
  ggplot(aes(fct_reorder(platform, n), n)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Repository platforms",
    caption = "Data: open-archaeo.info",
    x = NULL, y = "Number of projects"
  )
```

Here again we see R is overwhelmingly dominant; closely followed by Python.
Plugins for QGIS and mobile apps are also relatively popular.
The remainder show a rather fragmented landscape of plugins for other desktop software (e.g. AutoCAD, ArcGIS); lesser used programming languages; and custom form and spreadsheet templates.

### Open source

#### Code availability and license

All entries on open-archaeo include source code in some form, but how many have a version-controlled repository? What repository hosts are the most popular?

```{r plot-repo-hosts}
# TODO: add "none"
# TODO: version with unique authors
oarch %>% 
  pivot_longer(c(github, gitlab, bitbucket, launchpad, codeberg),
               names_to = "repo_host", values_to = "repo_url") %>% 
  drop_na(repo_url) %>% 
  count(repo_host) %>% 
  arrange(-n) %>%
  ggplot(aes(fct_reorder(repo_host, n, .desc = TRUE), n)) +
  geom_col() +
  labs(title = "Repository hosts",
       caption = "Data: open-archaeo.info",
       x = NULL, y = "Number of projects")
```
ZB note: How many users per platform? Codeberg is second but only has one user.

How many are explicitly licensed? What are the most popular licenses?

#### Repository activity

(On GitHub:)

  * How active is the average repository?
  * How fast have repositories been growing?

```{r plot-gh_commits-cum}
oarch %>%
  unnest(gh_commits) %>%
  drop_na(sha) %>%
  mutate(date = floor_date(datetime, "week")) %>%
  mutate(rough_category = recode(
    rough_category,
    "Standalone apps" = "Standalone apps",
    "Packages (R, Python, etc.)" = "Packages (R, Python, etc.)",
    .default = "Other")) %>%
  group_by(rough_category, date) %>%
  summarise(n_commits = n(), .groups = "drop_last") %>%
  mutate(cat_total = sum(n_commits)) %>%
  mutate(cum_commits = cumsum(n_commits)) %>%
  ggplot(aes(date, cum_commits,
             fill = fct_reorder(rough_category, cat_total),
             colour = fct_reorder(rough_category, cat_total))) +
  geom_area() +
  scale_x_datetime(limits = c(ymd("2008-01-01", tz = "UTC"), NA),
                   date_breaks = "1 years",
                   date_labels = "%Y") +
  scale_colour_contrast(guide = NULL) +
  scale_fill_contrast(guide = guide_legend(reverse = TRUE)) +
  labs(
    title = "Open Archaeology",
    subtitle = "Cumulative commits in GitHub repositories",
    caption = "Data: <https://open-archaeo.info> and the GitHub API",
    x = NULL, y = NULL, fill = NULL
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "IBM Plex Sans"),
    legend.position = "bottom",
    legend.justification = "right",
    legend.margin = margin(),
    legend.box.margin = margin()
  )
```

ZB note / idea: Plot the dates of the first commits from each project to track the initiation of projects over time. Then a secondary analysis does the same thing but with a filter to limit the dataset to include only those projects with a certain minimum number of commits or issues (or whatever metric for activity we plan to use), or that have had activity during the past 3 months, i.e. what are the ages of projects that actually had active or ongoing development, or that are still active today? This might indicate the average lifespans of projects, or the properties of particularly active projects can be dissected to identify common practices that we can infer are the causes of their liveliness.

```{r plot-lifespan}
min_commits <- 5

oarch %>% 
  unnest(gh_commits) %>% 
  drop_na(datetime) %>% 
  group_by(item_name) %>%
  add_tally() %>% 
  filter(n >= min_commits) %>% 
  mutate(first_commit = min(datetime),
         mid_commit = median(datetime),
         last_commit = max(datetime)) %>%
  ggplot(aes(x = fct_reorder(item_name, mid_commit, .desc = TRUE),
             y = datetime,
             ymin = first_commit,
             ymax = last_commit)) +
  geom_linerange() +
  geom_point(shape = "|") +
  scale_y_datetime(date_breaks = "1 year") +
  coord_flip() +
  labs(
    title = "Project lifespan",
    subtitle = glue("Individual commits in GitHub repositories (with {min_commits} or more commits)"),
    x = NULL, y = NULL,
    caption = "Data: open-archaeo.info and GitHub API"
  )
```

```{r lifespan-stats}
oarch %>% 
  unnest(gh_commits) %>% 
  drop_na(datetime) %>% 
  group_by(item_name) %>%
  summarise(
    n = n(),
    first_commit = min(datetime),
    last_commit = max(datetime),
    lifespan = as.integer(last_commit - first_commit),
    commit_rate = n / lifespan
  ) ->
  oarch_lifespan
```

```{r plot-lifespan-hist}
oarch_lifespan %>% 
  ggplot(aes(x = lifespan)) +
  geom_histogram() +
  labs(
    title = "Project lifespan",
    subtitle = "Time between first and latest commit",
    x = "Days", y = "Repositories",
    caption = "Data: open-archaeo.info and GitHub API"
  )
```
```{r plot-rate-hist}
oarch_lifespan %>% 
  ggplot(aes(x = commit_rate)) +
  geom_histogram() +
  labs(
    title = "Project activity",
    subtitle = "Average commit rate",
    x = "Commits per day", y = "Repositories",
    caption = "Data: open-archaeo.info and GitHub API"
  )
```

What are the characteristics of long-lived and/or active repositories?

```{r plot-lifespan-vs-rate}
oarch_lifespan %>% 
  ggplot(aes(x = lifespan, y = commit_rate)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  labs(
    title = "Project lifespan vs. average commit rate",
    x = "Lifespan (days)", y = "Commits per day",
    caption = "Data: open-archaeo.info and GitHub API"
  )
```

TODO: ZB: Any ideas for other relevant factors? Lots of ways you could go here...

#### Growth

### Collaboration

TODO: For this we need **covariaties**! Could be:

* Domain (tags and categories)
* Time
* Social aspects: e.g. centrality extracted from network analysis

#### Number of collaborators and roles

```{r plot-gh_contributors-histogram}
oarch %>%
  drop_na(gh_repo) %>%
  unnest(gh_contribs) %>%
  group_by(gh_repo) %>%
  summarise(n = n(), .groups = "drop") %>%
  ggplot(aes(x = n)) +
  geom_histogram(binwidth = 1) +
  labs(
    title = "Repository contributors",
    caption = "Data: <https://open-archaeo.info> and the GitHub API",
    x = "Number of contributors", y = "Number of repositories"
  )
```

#### Forks and pull requests

#### Issues and comments

```{r plot-gh_issues-histogram}
oarch %>%
  unnest(gh_issues) %>%
  drop_na(title) %>%
  group_by(repo) %>%
  summarise(n = n(), .groups = "drop") %>%
  ggplot(aes(x = n)) +
  geom_histogram(binwidth = 1) +
  labs(
    title = "Repository issues",
    caption = "Data: <https://open-archaeo.info> and the GitHub API",
    x = "Number of issues", y = "Number of repositories"
  )
```


#### Collaborative networks

If we construct a network linking repositories by their common contributors, can we identify emerging networks of collaboration, or are individual projects still largely isolated? If there are networks, what characterises their links?

ZB: I'm speculating that there are going to be various users who have their fingers in many projects, and that those projects tend to be the most active. If this is the case, I would further speculate that these people hold a different attitude regarding authorship and the dividuality of projects that is more in sync with the collaborative capabilities of open source, which are at odds with traditional academic norms regarding how contributions are credited and how products are produced are disseminated.



